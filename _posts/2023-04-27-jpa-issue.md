---
title: JPA, DB가 일으킨 장애 해결 기록
author: 박경덕
date: 2023-04-27 11:50:00 +0900
categories: [경험, 트러블슈팅]
tags: [jpa, db-lock]
---

## 상황

* MSA 구조로 서버 간 HTTP 통신을 하고 있음.
* 레거시 모놀리틱 구조에서 MSA 로 전환 중에 있어서 서버는 분리되어 있으나 실제 DB는 하나로 쓰고 있는 상황

## 발단

설명하기 위해 자식 부모 관계인 책(Book) 도메인과 작가(Author) 도메인으로 예시를 들자면,

![Desktop View](/assets/img/posts/2023-04-27-jpa-issue_api-example.png)

이런 구조의 API가 있었다.

발생한 문제는 **해당 API의 Author Update 동작에서 DB timeout**이 떨어진다는 것.

## 파악

기존에 잘 돌고 있던 API라 최초 알럿이 날라 왔을 땐 네트워크 상의 일시적 장애일 것이라 생각했으나

로그 확인 결과 같은 요청, 에러가 2번 연속으로 온 것을 확인, 누군가 어드민에서 시도했다가 실패해서 재시도한 것으로 판단.

원인 분석을 위해 일단 로그와 같은 요청을 시도, 동일한 에러가 재현되는 것을 보고 일시적 에러는 아님을 확인.

혹시 Author 서버의 설정, 혹은 Author Update API가 문제인가 싶어서 해당 API만 별도로 호출 시도, 하지만 이 경우 정상적으로 작동함을 확인.

코드 레벨에서 Transaction 거는 부분이나 로직 자체에 어떤 문제가 있을까 살펴보았지만 큰 로직이 있는 API가 아니였기에 별다른 점 발견하지 못함.

## 원인

결국 트랜잭션 이슈인 것은 확실한데 정확한 원인 파악을 하지 못하고 있던 중

혹시 **외래키가 걸려 있으면 부모도 락을 잡아버리나**? 라는 생각이 들었고 해당 부분을 찾아보았는데...

**[생각했던 것이 맞았다](https://m.blog.naver.com/parkjy76/220639066476)**.

**그렇다면 왜 기존에 잘 돌던 API가 문제를 일으킨 것일까?**

그것 역시 범인은 나였다.

최근 모종의 사유로 공통 Repository 클래스 저장 로직을

```java
entityManager.persist(entity);
```

에서

```java
entityManager.persist(entity);
entityManager.flush();
entityManager.detach(entity);
```

로 변경했는데 이 부분이 문제가 되었다.

트랜잭션이 끝날때 flush 되는 것이 아닌 강제로 중간에 flush를 시켜버려서

기존

```
Book tr start

Author tr start

Author flush & commit

Book flush & commit
```

였던 흐름이

```
Book tr start

Book flush (lock)

Author tr start

Author flush (timeout)
```

의 흐름으로 바뀌었기 때문!

## 조치

일단 결론적으론 문제가 됐던 변경 사항을 되돌리는 것으로 결정이 났다.

해당 수정은 여러 엔티티를 insert하는 과정에서 트랜잭션이 끝날 때

insert된 일부 엔티티에 set updatedAt = now() 인 쓸모없는 쿼리가 한 번 더 나가는 걸 막으려는 조치였다.

하지만 실질적으로 추가 쿼리에 대한 퍼포먼스 & updatedAt 시간 오차의 미세함 등을 따져봤을 때

득 보다 실이 더 큰 작업이었던 것이었다(물론 그 당시엔 몰랐지만).

updatedAt 쿼리 이슈는 추후 다른 방식으로 해결할 방법을 연구할 예정.

## 사유
* 당연한 얘기지만 공통 부분을 건드리는 것은 극도로 조심해야겠다.
* 리더 분께서 일반적으로 외래키를 걸때는 DBA 등에게 이유를 소명해야 걸 수 있다고 하셨다.
  * 즉, 기본은 안거는 것이라는 얘기.
  * 예전엔 YES 정규화 NO 비정규화, 외래키 등 제약조건 필수 정석대로! 였으나 최근엔 생각이 많이 바뀌는 것 같다.
* DB 관련은 모델링이나 인프라적인 걸 제외하면 사실상 Lock 아니면 인덱스 관련인 게 대다수인 것 같다.
  * 이슈를 처리하는데 긴 시간이 걸린 건 아니지만 사전이 미리 외래키 공유락에 대해 알았다면 더 빨리 처리했을 것 같다.
  * 두 부분은 틈틈이 공부해 둘 것.
